<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portfolio VaR Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #111; color: #eee; margin: 0; padding: 20px; }
    h1, h2 { color: #f5a623; text-align: center; }
    .container { max-width: 900px; margin: auto; background: #1a1a1a; padding: 20px; border-radius: 12px; box-shadow: 0 0 15px rgba(245,166,35,0.1); }
    input, button { padding: 10px; margin: 5px; border-radius: 6px; border: none; }
    input { background: #333; color: #fff; width: 160px; }
    button { background: #f5a623; color: #000; font-weight: bold; cursor: pointer; }
    button:hover { background: #e69500; }
    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    th, td { padding: 10px; text-align: center; border: 1px solid #444; }
    th { background: #f5a623; color: #000; }
    #loadingSpinner { text-align: center; margin: 20px 0; display: none; }
    #chart { background: #111; border-radius: 8px; }
    .section { margin: 25px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Portfolio VaR Calculator</h1>

    <!-- SEARCH -->
    <div class="section">
      <h2>Search Ticker</h2>
      <input type="text" id="searchInput" placeholder="e.g. AAPL" />
      <button id="searchButton">Search</button>
      <div id="searchResults"></div>
    </div>

    <!-- PORTFOLIO -->
    <div class="section">
      <h2>Portfolio</h2>
      <table id="portfolioTable"></table>
    </div>

    <!-- CALCULATE -->
    <div class="section" style="text-align:center;">
      <button id="calculateVar" style="padding:12px 30px; font-size:1.1em;">Calculate VaR</button>
      <div id="loadingSpinner">Loading...</div>
    </div>

    <!-- RESULTS + CHART -->
    <div class="section">
      <h2>Portfolio VaR Results</h2>
      <div id="resultsTable"></div>
      <canvas id="chart" height="320"></canvas>
    <div class="section" id="stressSection" style="display:none;">
      <h2 style="color:#ff6b6b;">Stress Test Lab</h2>
      <button id="runStress" style="background:#ff6b6b; padding:12px 25px; font-weight:bold;">Run Stress Test</button>
      <div id="stressResults" style="margin-top:20px;"></div>
    </div>
<style>
  .stress-card {
    background: #2a2a2a; padding: 15px; border-radius: 10px; margin: 12px 0;
    border-left: 5px solid #ff6b6b; box-shadow: 0 2px 8px rgba(255,107,107,0.2);
  }
  .stress-name { font-weight: bold; color: #ff6b6b; font-size: 1.1em; }
  .stress-cvar { color: #f66; font-size: 1.3em; }
  .stress-change { font-size: 1.1em; }
  .stress-hedge { color: #4ecdc4; font-style: italic; margin-top: 8px; }
  .impact-bar {
    height: 8px; background: #444; border-radius: 4px; margin: 8px 0; overflow: hidden;
  }
  .impact-fill {
    height: 100%; background: #ff6b6b; transition: width 0.6s ease;
  }
</style>
    </div>
  </div>

  <!-- SCRIPT -->
  <script>
    // script.js — FULLY INCLUDED BELOW (no external file needed for testing)
    const API = "https://portfolio-var-calculator.onrender.com";
  

    let portfolio = [], chart = null;
    const inp   = document.getElementById("searchInput");
    const btn   = document.getElementById("searchButton");
    const res   = document.getElementById("searchResults");
    const tbl   = document.getElementById("portfolioTable");
    const calc  = document.getElementById("calculateVar");
    const out   = document.getElementById("resultsTable");
    const spin  = document.getElementById("loadingSpinner");

    function loading(txt){ spin.style.display="block"; spin.textContent=txt; }
    function hide(){ setTimeout(()=>{spin.style.display="none";},400); }

    btn.onclick = async () => {
      const t = inp.value.trim().toUpperCase(); if(!t) return;
      loading(`Searching ${t}…`);
      try{
        const r = await fetch(`${API}/ticker/${t}`);
        if(!r.ok) throw await r.json();
        const d = await r.json();
        res.innerHTML = `
          <div style="padding:10px;background:#222;border-radius:6px;margin:8px 0;">
            <strong>${d.name}</strong> (${d.symbol}) – $${d.price}
            <input id="w" type="number" min="1" max="100" placeholder="Weight %" style="width:70px;margin-left:8px;">
            <button onclick="add('${d.symbol}','${d.name.replace(/'/g,"\\'")}')" 
                    style="margin-left:6px;background:#f5a623;color:#000;border:none;padding:4px 10px;border-radius:4px;">Add</button>
          </div>`;
      }catch(e){ res.innerHTML=`<p style="color:#f66;">${e.detail||e}</p>`; }
      hide();
    };

    function add(sym,name){
      const w = parseFloat(document.getElementById("w").value);
      if(isNaN(w)||w<1||w>100){alert("Weight 1-100%");return;}
      const ex = portfolio.find(p=>p.symbol===sym);
      ex? ex.weight=w : portfolio.push({symbol:sym,name,weight:w});
      drawTable(); res.innerHTML=""; inp.value="";
    }
    function remove(i){ portfolio.splice(i,1); drawTable(); }

    function drawTable(){
      tbl.innerHTML=""; let tot=0;
      portfolio.forEach((p,i)=>{
        tot+=p.weight;
        const tr=tbl.insertRow();
        tr.innerHTML=`<td>${p.name} (${p.symbol})</td><td>${p.weight}%</td>
                      <td><button onclick="remove(${i})" 
                      style="background:#c33;color:#fff;padding:3px 7px;border:none;border-radius:3px;">X</button></td>`;
      });
      const ft=tbl.insertRow(); ft.innerHTML=`<td><b>Total</b></td><td><b>${tot.toFixed(1)}%</b></td><td></td>`;
    }

    calc.onclick = async () => {
      if(!portfolio.length){ out.innerHTML="<p>Add securities first.</p>"; return; }
      loading("Calculating VaR…");
      try{
        const r = await fetch(`${API}/var`,{
          method:"POST", headers:{"Content-Type":"application/json"},
          body:JSON.stringify({symbols:portfolio.map(p=>p.symbol),weights:portfolio.map(p=>p.weight)})
        });
        if(!r.ok) throw await r.json();
        const d = await r.json();
        renderTable(d);
        renderChart(d);
      }catch(e){ out.innerHTML=`<p style="color:#f66;">${e.detail||e}</p>`; }
      hide();
    };

    function renderTable(data){
      let h=`<table border=1 style="width:100%;margin:12px 0;border-collapse:collapse;">
             <tr style="background:#f5a623;color:#000;"><th>Security</th><th>Normal 95%</th>
             <th>Hist 95%</th><th>MC 95%</th><th>CF 95%</th><th>Exp Return</th></tr>`;
      for(const [k,v] of Object.entries(data)){
        const bold = k==="Portfolio" ? "style='font-weight:bold;color:#f5a623'" : "";
        h+=`<tr><td ${bold}><b>${k}</b></td>
             <td>${v.Normal95}</td><td>${v.Hist95}</td><td>${v.MC95}</td>
             <td>${v.CF95}</td><td>${(v.ExpReturn*100).toFixed(2)}%</td></tr>`;
      }
      out.innerHTML = h+"</table>";
    }

    function renderChart(data){
      const ctx = document.getElementById("chart")?.getContext("2d");
      if(!ctx) return;
      const pts=[], col=[], sz=[];
      for(const [k,v] of Object.entries(data)){
        pts.push({x: -v.Normal95*100, y: v.ExpReturn*100, label:k==="Portfolio"?"PORTFOLIO":k});
        col.push(k==="Portfolio"?"#ff0000":"#f5a623");
        sz.push(k==="Portfolio"?12:8);
      }
      if(chart) chart.destroy();
      chart = new Chart(ctx,{
        type:"scatter", data:{datasets:[{data:pts, backgroundColor:col, pointRadius:sz}]},
        options:{responsive:true, plugins:{legend:{display:false}},
                 scales:{x:{title:{display:true,text:"VaR 95% loss (%)"}}, 
                         y:{title:{display:true,text:"Exp. annual return (%)"}}}}
      });
    }
  // === STRESS TEST LAB ===
const stressBtn = document.getElementById("runStress");
const stressRes = document.getElementById("stressResults");
const stressSection = document.getElementById("stressSection");

if (stressBtn) {
  stressBtn.onclick = async () => {
    if (!portfolio.length) {
      alert("Build a portfolio first!");
      return;
    }
    stressBtn.disabled = true;
    stressBtn.textContent = "Running...";
    stressRes.innerHTML = "<p style='color:#aaa;'>Simulating shocks...</p>";

    try {
      const payload = {
        symbols: portfolio.map(p => p.symbol),
        weights: portfolio.map(p => p.weight)
      };
      const r = await fetch(`${API}/cvar-stress`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!r.ok) throw await r.json();
      const d = await r.json();

      let html = `<div style="font-weight:bold; color:#fff; margin-bottom:10px;">
                    Baseline CVaR: ${(d.baseline.CF95 * 100).toFixed(2)}%
                  </div>`;

      for (const [name, val] of Object.entries(d.stress)) {
        const change = val["Change (%)"];
        const barWidth = Math.min(Math.abs(change), 100);
        const isLoss = change > 0;
        html += `
          <div class="stress-card">
            <div class="stress-name">${name}</div>
            <div class="stress-cvar">${(val.CVaR * 100).toFixed(2)}% CVaR</div>
            <div class="stress-change">
              ${isLoss ? "↑" : "↓"} ${Math.abs(change).toFixed(1)}% vs baseline
            </div>
            <div class="impact-bar">
              <div class="impact-fill" style="width:${barWidth}%; background:${isLoss ? '#ff6b6b' : '#4ecdc4'};"></div>
            </div>
            <div class="stress-hedge">Hedge: ${val.Hedge}</div>
          </div>`;
      }
      stressRes.innerHTML = html;
    } catch (e) {
      stressRes.innerHTML = `<p style="color:#f66;">Error: ${e.detail || e}</p>`;
    } finally {
      stressBtn.disabled = false;
      stressBtn.textContent = "Run Stress Test";
    }
  };
}

// SHOW STRESS LAB AFTER VaR
const originalCalc = calc.onclick;
calc.onclick = async () => {
  if (originalCalc) await originalCalc();
  stressSection.style.display = "block";
};
  </script>
</body>
</html>
